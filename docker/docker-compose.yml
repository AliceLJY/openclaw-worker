# OpenClaw 本地 Docker 部署
# 架构：Docker(OpenClaw + Task API) <-> 本地 Worker <-> 本地 CC
#
# Docker 内不装 CC，通过 Task API 调用外部 Worker

services:
  # OpenClaw 网关服务
  openclaw-gateway:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw-gateway
    restart: always
    ports:
      - "18789:18789"  # Web UI
      - "18790:18790"  # Bridge
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-~/.openclaw-docker}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:-~/openclaw-workspace}:/home/node/workspace
    environment:
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - OPENCLAW_GATEWAY_HOST=0.0.0.0
      # Telegram 代理已在 openclaw.json channels.telegram.proxy 配置，不需要全局代理
    command: ["node", "openclaw.mjs", "gateway", "run", "--bind", "lan", "--port", "18789", "--allow-unconfigured"]
    init: true
    healthcheck:
      test: ["CMD", "sh", "-c", "node -e \"fetch('http://127.0.0.1:18789/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\" && grep -q 'logged in to discord' /tmp/openclaw/openclaw-$(date +%Y-%m-%d).log"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 90s
    labels:
      - "autoheal=true"
    networks:
      - openclaw-net

  # Task API 服务（从根目录 server.js 构建）
  task-api:
    build:
      context: ..
      dockerfile: docker/task-api/Dockerfile
    container_name: openclaw-task-api
    restart: always
    ports:
      - "3456:3456"  # Task API 端口
    volumes:
      - ../server.js:/app/server.js:ro  # 热补丁：修复清理逻辑 bug
      - /var/run/docker.sock:/var/run/docker.sock  # Callback: docker exec into bot containers
    environment:
      - WORKER_TOKEN=${WORKER_TOKEN}
      - PORT=3456
      - CALLBACK_CONTAINER=openclaw-gateway  # Default: 睿智bot; per-request callbackContainer overrides
    networks:
      - openclaw-net

  # CLI 工具（按需启动）
  openclaw-cli:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw-cli
    profiles: ["cli"]
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-~/.openclaw-docker}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:-~/openclaw-workspace}:/home/node/workspace
    environment:
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
    entrypoint: ["node", "openclaw.mjs"]
    stdin_open: true
    tty: true
    networks:
      - openclaw-net

  # 自动重启不健康的容器（WiFi 断线恢复后自动重连 Discord）
  autoheal:
    image: willfarrell/autoheal
    container_name: autoheal-gateway
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=30
      - AUTOHEAL_START_PERIOD=60

networks:
  openclaw-net:
    driver: bridge
