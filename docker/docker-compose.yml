# OpenClaw 本地 Docker 部署
# 架构：Docker(OpenClaw + Task API) <-> 本地 Worker <-> 本地 CC
#
# Docker 内不装 CC，通过 Task API 调用外部 Worker

services:
  # OpenClaw 网关服务
  openclaw-gateway:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw-gateway
    restart: always
    ports:
      - "18789:18789"  # Web UI
      - "18790:18790"  # Bridge
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-~/.openclaw-docker}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:-~/openclaw-workspace}:/home/node/workspace
    environment:
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
      - OPENCLAW_GATEWAY_HOST=0.0.0.0
      # 代理配置已移除 - 内网代理 10.51.58.73 在外出时不可达
      # 如需代理，请使用稳定的公网代理服务
      # - HTTP_PROXY=http://your-stable-proxy:port
      # - HTTPS_PROXY=http://your-stable-proxy:port
      # 不配置 Anthropic API，通过 Task API 调用外部 CC
    command: ["node", "openclaw.mjs", "gateway", "run", "--bind", "lan", "--port", "18789", "--allow-unconfigured"]
    init: true
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:18789/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - openclaw-net

  # Task API 服务（从你现有的 server.js 构建）
  task-api:
    build:
      context: ./task-api
      dockerfile: Dockerfile
    container_name: openclaw-task-api
    restart: always
    ports:
      - "3456:3456"  # Task API 端口
    environment:
      - WORKER_TOKEN=${WORKER_TOKEN}
      - PORT=3456
    networks:
      - openclaw-net

  # CLI 工具（按需启动）
  openclaw-cli:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw-cli
    profiles: ["cli"]
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-~/.openclaw-docker}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:-~/openclaw-workspace}:/home/node/workspace
    environment:
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}
    entrypoint: ["node", "openclaw.mjs"]
    stdin_open: true
    tty: true
    networks:
      - openclaw-net

networks:
  openclaw-net:
    driver: bridge
