# OpenClaw Antigravity Bot
# 独立容器，使用 Google Antigravity API
# 共享 Task API 调用本地 Claude Code

services:
  # Antigravity Bot 网关服务
  openclaw-antigravity:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw-antigravity
    restart: always
    ports:
      - "18791:18789"  # Web UI（不同端口避免冲突）
      - "18792:18790"  # Bridge
    volumes:
      - ~/.openclaw-antigravity:/home/node/.openclaw
      - ~/openclaw-workspace:/home/node/workspace
      # Patch: strip unsigned thinking blocks to fix Antigravity Claude multi-turn error
      - ~/.openclaw-antigravity/patches/messages.js:/app/node_modules/@mariozechner/pi-coding-agent/dist/core/messages.js:ro
    environment:
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_ANTIGRAVITY_TOKEN:-antigravity-bot-token}
      - OPENCLAW_GATEWAY_HOST=0.0.0.0
    command: ["node", "openclaw.mjs", "gateway", "run", "--bind", "lan", "--port", "18789", "--allow-unconfigured"]
    init: true
    healthcheck:
      test: ["CMD", "sh", "-c", "node -e \"fetch('http://127.0.0.1:18789/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\" && grep -q 'logged in to discord' /tmp/openclaw/openclaw-$(date +%Y-%m-%d).log"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 90s
    labels:
      - "autoheal=true"
    networks:
      - openclaw-net

  # CLI 工具（按需启动）
  openclaw-antigravity-cli:
    image: ghcr.io/openclaw/openclaw:latest
    container_name: openclaw-antigravity-cli
    profiles: ["cli"]
    volumes:
      - ~/.openclaw-antigravity:/home/node/.openclaw
      - ~/openclaw-workspace:/home/node/workspace
    environment:
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_ANTIGRAVITY_TOKEN:-antigravity-bot-token}
    entrypoint: ["node", "openclaw.mjs"]
    stdin_open: true
    tty: true
    networks:
      - openclaw-net

  # 自动重启不健康的容器（WiFi 断线恢复后自动重连）
  autoheal:
    image: willfarrell/autoheal
    container_name: autoheal-antigravity
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=30
      - AUTOHEAL_START_PERIOD=60

networks:
  openclaw-net:
    external: true
    name: openclaw-docker_openclaw-net
